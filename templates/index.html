{% extends 'base.html' %}
{% block content %}

<header class="row" style="align-items:center; gap:12px;">
  <h2 class="grow" style="margin:0;">Documents</h2>

  <!-- Controls -->
  <input id="filter-q" placeholder="Search by title…"
         style="min-width:220px;">
  <label class="row" style="gap:6px; align-items:center;">
    <span class="muted" style="font-size:12px;">Sort</span>
    <select id="sort-by">
      <option value="updated">Last updated</option>
      <option value="title">Title A–Z</option>
      <option value="title-desc">Title Z–A</option>
    </select>
  </label>
  <div class="row" style="gap:10px; align-items:center;">
    <label class="row" style="gap:6px; align-items:center;">
      <input type="checkbox" id="show-owned" checked> <span class="muted" style="font-size:12px;">Owned</span>
    </label>
    <label class="row" style="gap:6px; align-items:center;">
      <input type="checkbox" id="show-shared" checked> <span class="muted" style="font-size:12px;">Shared</span>
    </label>
    <label class="row" style="gap:6px; align-items:center;">
      <input type="checkbox" id="show-public" checked> <span class="muted" style="font-size:12px;">Public</span>
    </label>
  </div>

  {% if current_user.is_authenticated %}
    <a class="btn primary" href="{{ url_for('docs.new_doc_form') }}">New Document</a>
  {% else %}
    <a class="btn" href="{{ url_for('auth.login_form') }}">Login</a>
    <a class="btn" href="{{ url_for('auth.register_form') }}">Register</a>
  {% endif %}
</header>

<!-- Empty state -->
<div id="empty" class="muted" style="margin-top:12px; display:none;">No documents match your filters.</div>

{% if docs and docs|length > 0 %}
  <ul id="doc-list" class="doc-list" style="list-style:none; padding:0; margin-top:12px;">
    {% for d in docs %}
      {% set is_owner  = current_user.is_authenticated and current_user.id == d.owner_id %}
      {% set is_public = d.is_public %}
      {% set is_shared = current_user.is_authenticated and (not is_owner) %}
      {% set updated   = (d.updated_at or d.created_at) %}
      <li class="doc-card"
          data-id="{{ d.id }}"
          data-title="{{ (d.title or '')|lower }}"
          data-owned="{{ 1 if is_owner else 0 }}"
          data-shared="{{ 1 if is_shared else 0 }}"
          data-public="{{ 1 if is_public else 0 }}"
          data-updated="{{ updated.isoformat() }}"
          style="margin:10px 0; padding:14px; border:1px solid var(--border); border-radius:12px; background:var(--card);">
        <div class="row" style="gap:12px; align-items:flex-start;">
          <div class="grow">
            <div class="row" style="gap:8px; align-items:center;">
              <a href="{{ url_for('docs.view_doc', doc_id=d.id) }}"><strong>{{ d.title }}</strong></a>
              <!-- Badges -->
              {% if is_owner %}
                <span class="pill">Owner</span>
              {% elif is_shared %}
                <span class="pill">Shared</span>
              {% endif %}
              <span class="pill" title="Visibility">{{ 'Public' if is_public else 'Private' }}</span>
            </div>
            <div class="muted" style="font-size:12px; margin-top:4px;">
              #{{ d.id }} · Updated {{ updated.strftime('%Y-%m-%d %H:%M') }}
            </div>
          </div>

          <!-- Quick actions -->
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            {% if is_owner %}
              <!-- Toggle visibility -->
              <form method="post" action="{{ url_for('docs.toggle_public', doc_id=d.id) }}">
                <button class="btn" title="{{ 'Make Private' if d.is_public else 'Make Public' }}">
                  {{ 'Make Private' if d.is_public else 'Make Public' }}
                </button>
              </form>
            {% endif %}

            <button class="btn" data-copy="{{ url_for('docs.share_link', doc_id=d.id) }}" data-doc="{{ d.id }}">Copy Link</button>

            {% if is_owner %}
              <a class="btn" href="{{ url_for('docs.edit_doc', doc_id=d.id) }}">Edit</a>
              <form method="post"
                    action="{{ url_for('docs.delete_doc', doc_id=d.id) }}"
                    onsubmit="return confirm('Delete this document? This cannot be undone.');">
                <button class="btn danger">Delete</button>
              </form>
            {% endif %}
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="muted" style="margin-top:12px;">No documents yet.</p>
{% endif %}

<!-- Tiny styles to make pills/buttons pop -->
<style>
  .pill { padding:2px 8px; border-radius:999px; background: var(--chip, #eef2ff); font-size:12px; }
  .doc-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,.06); }
</style>

<!-- Client-side filtering/sorting + copy link helper -->
<script>
(function(){
  const list = document.getElementById('doc-list');
  const empty = document.getElementById('empty');
  const q = document.getElementById('filter-q');
  const sortBy = document.getElementById('sort-by');
  const owned = document.getElementById('show-owned');
  const shared = document.getElementById('show-shared');
  const pub = document.getElementById('show-public');

  function apply(){
    if (!list) return;
    const term = (q.value || '').toLowerCase().trim();
    const showOwned = owned.checked, showShared = shared.checked, showPublic = pub.checked;

    const items = [...list.querySelectorAll('.doc-card')];
    let visibleCount = 0;

    items.forEach(li => {
      const t = li.dataset.title || '';
      const isOwned = li.dataset.owned === '1';
      const isShared = li.dataset.shared === '1';
      const isPublic = li.dataset.public === '1';

      const passQ = !term || t.includes(term);
      const passRole = (isOwned && showOwned) || (isShared && showShared) || (isPublic && showPublic);

      const show = passQ && passRole;
      li.style.display = show ? '' : 'none';
      if (show) visibleCount++;
    });

    // sort visible
    const mode = sortBy.value;
    const visible = items.filter(li => li.style.display !== 'none');
    let comp = (a,b)=>0;
    if (mode === 'updated') {
      comp = (a,b)=> Date.parse(b.dataset.updated) - Date.parse(a.dataset.updated);
    } else if (mode === 'title') {
      comp = (a,b)=> (a.dataset.title> b.dataset.title) - (a.dataset.title< b.dataset.title);
    } else if (mode === 'title-desc') {
      comp = (a,b)=> (b.dataset.title> a.dataset.title) - (b.dataset.title< a.dataset.title);
    }
    visible.sort(comp).forEach(el => list.appendChild(el));

    empty.style.display = visibleCount ? 'none' : 'block';
  }

  if (q) q.addEventListener('input', apply);
  if (sortBy) sortBy.addEventListener('change', apply);
  if (owned) owned.addEventListener('change', apply);
  if (shared) shared.addEventListener('change', apply);
  if (pub) pub.addEventListener('change', apply);

  // Copy link buttons: fetch real share URL then copy
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-copy]');
    if (!btn) return;
    e.preventDefault();
    try {
      const href = btn.getAttribute('data-copy');
      // GET returns {"share_url": "..."}
      const res = await fetch(href);
      const j = await res.json();
      await navigator.clipboard.writeText(j.share_url);
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy Link', 1200);
    } catch (err) {
      alert('Could not copy link.');
    }
  });

  // Initial pass
  apply();
})();
</script>

{% endblock %}
